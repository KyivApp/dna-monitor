<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>DNA Monitor</title>
    <link rel="stylesheet" href="node_modules/photonkit/dist/css/photon.css">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="error">
        Searching for DNA device...
    </div>
    <div id="chart"></div>
    <div id="controls">
        <span class="label">Power</span><input class="form-control" id="psp" type="number"> <span class="unit">W</span>
        <input class="btn btn-large btn-default" id="setp" type="button" value="set">
        <span class="label">Temperature</span><input class="form-control" id="tsp" type="number">
        <select class="form-control" id="degreeunit">
            <option value="C">°C</option>
            <option value="F">°F</option>
            <!--<option value="OFF">OFF</option>-->
        </select>
        <input class="btn btn-large btn-default" id="sett" type="button" value="set">
        <span class="label"></span>
        <input class="btn btn-large btn-default" id="fire" type="button" value="fire">
        <input class="form-control" id="duration" type="number" value="1.0">
        <span class="unit">s</span>
    </div>
  </body>

  <script>
    require('./renderer.js');

    const ipc = require('electron').ipcRenderer;
    const $ = jQuery = require('jquery');
    const Highcharts = require('highcharts');
    require('highcharts/themes/gray.js')(Highcharts);


    ipc.on('sport', function (event, data) {
        if (data) {
            $('#error').hide();
        } else {
            $('#error').show();
            $('#tsp').val('');
            $('#psp').val('');
            chart.series[0].setData([]);
            chart.series[1].setData([]);
            chart.redraw();
        }
    });

    var running;
    var degreeunit;
    var start;
    ipc.on('values', function (event, data) {
        if (data.P.match(/W/)) {
            if (!running) {
                chart.series[0].setData([]);
                chart.series[1].setData([]);
                chart.redraw();
                start = (new Date()).getTime();
                running = true;
                setpChange = false;
                settChange = false;
                setpVal = null;
                settVal = null;
            }

            if (running && !degreeunit && data.T.match(/C/)) {
                chart.yAxis[0].update({
                    labels: {
                        format: '{value}°C'
                    }
                });
                $('#degreeunit').val('C');
                degreeunit = true;

            } else if (running && !degreeunit && data.T.match(/F/)) {
                chart.yAxis[0].update({
                    labels: {
                        format: '{value}°F'
                    }
                });
                $('#degreeunit').val('F');
                degreeunit = true;
            }

            var t = parseFloat(data.T.replace('C', ''));
            var p = parseFloat(data.P.replace('W', ''));
            var elapsed = ((new Date()).getTime() - start) / 1000;
            chart.series[0].addPoint([elapsed, t], true, false, false);
            chart.series[1].addPoint([elapsed, p], true, false, false);
      } else {
        running = false;
        degreeunit = false;
      }
    });

    var setpVal;
    var setpChange;
    var settVal;
    var settChange;

    ipc.on('setpoints', function (event, data) {
        var p = parseFloat(data.P.replace('W', ''));
        if (setpVal !== p) {
            setpVal = p;
            if (!setpChange) $('#psp').val(setpVal);
        }
        var t = parseFloat(data.T.replace('C', ''));
        if (settVal !== t) {
            settVal = t;
            if (!settChange) $('#tsp').val(settVal);
        }

    });

    $('#setp').click(function () {
        ipc.send('setp', $('#psp').val());
        setTimeout(function () {
            setpChange = false;
        }, 100);
    });
    $('#sett').click(function () {
        var unit = $('#degreeunit').val();
        if (unit === 'OFF') {
            ipc.send('sett', 'OFF');
        } else {
            ipc.send('sett', $('#tsp').val() + unit);
        }
        setTimeout(function () {
            settChange = false;
        }, 100);
    });

    $('#psp').change(function () {
        setpChange = $('#psp').val() !== setpVal;
    });

    $('#psp').focus(function () {
        setpChange = $('#psp').val() !== setpVal;
    });

    $('#tsp').change(function () {
        settChange = $('#tsp').val() !== settVal;
    });

    $('#tsp').focus(function () {
        settChange = $('#tsp').val() !== settVal;
    });

    $('#fire').click(function () {
        ipc.send('fire', $('#duration').val());
    });

    var series;
    var chart;
    $(document).ready(function() {
      chart = new Highcharts.Chart({
        chart: {
          renderTo: 'chart',
          type: 'line'

        },
        legend: {
          enabled: false
        },
        title: {text: ''},
        xAxis: {
          min: 0
        },
        yAxis: [{ // Primary yAxis
            minrange: 120,
          labels: {
            format: '{value}°C',
            style: {
              color: Highcharts.getOptions().colors[2]
            }

          },
          title: {
            text: 'Temperature',
            style: {
              color: Highcharts.getOptions().colors[2]
            }
          },
          opposite: false

        },
          { // Primary yAxis
            labels: {
              format: '{value} W',
              style: {
                color: Highcharts.getOptions().colors[3]
              }
            },
            title: {
              text: 'Power',
              style: {
                color: Highcharts.getOptions().colors[3]
              }
            },
            opposite: true

          }],
        plotOptions: {
          line: {
            marker: {
              enabled: false
            }
          }
        },
        series: [
          {
            name: 'Temperature',
            data: [],
            yAxis: 0,
            color: Highcharts.getOptions().colors[2]
          },
          {
            name: 'Power',
            data: [],
            yAxis: 1,
            color: Highcharts.getOptions().colors[3]
          }
        ]


      });
    })
  </script>
</html>
